# Advanced Features (v2.0+)

–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ CloudCastle DI Container v2.0 –∏ –≤—ã—à–µ.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [PHP 8+ Attributes](#php-8-attributes)
2. [Decorator Priorities](#decorator-priorities)
3. [Service Locator Pattern](#service-locator-pattern)
4. [Container Delegation](#container-delegation)
5. [Scoped Containers](#scoped-containers)
6. [Async Service Initialization](#async-service-initialization)
7. [Compiled Container with Tags](#compiled-container-with-tags)
8. [WeakMap Optimization](#weakmap-optimization)

---

## 1. PHP 8+ Attributes

### Overview

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Ç—Ä–∏–±—É—Ç—ã PHP 8+ –¥–ª—è –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã

#### `#[Service]`

–ú–∞—Ä–∫–∏—Ä—É–µ—Ç –∫–ª–∞—Å—Å –∫–∞–∫ —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

```php
use CloudCastle\DI\Attribute\Service;

#[Service(
    id: 'my.logger',          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: ID —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∏–º—è –∫–ª–∞—Å—Å–∞)
    tags: ['logger', 'core'], // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç–µ–≥–∏
    lazy: true,               // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    priority: 10              // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
)]
class MyLogger
{
    public function log(string $message): void
    {
        echo "[LOG] {$message}\n";
    }
}
```

#### `#[Inject]`

–£–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä.

```php
use CloudCastle\DI\Attribute\Inject;

class UserService
{
    public function __construct(
        #[Inject('my.logger')] private object $logger,
        #[Inject('cache.redis')] private object $cache
    ) {}
}
```

#### `#[Tag]`

–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–≥ –∫ —Å–µ—Ä–≤–∏—Å—É (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å multiple —Ä–∞–∑).

```php
use CloudCastle\DI\Attribute\Tag;

#[Service]
#[Tag('middleware', ['priority' => 10])]
#[Tag('security')]
class AuthMiddleware
{
    // ...
}
```

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤

```php
$container = new Container();
$container->enableAutowiring();

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
$container->registerFromAttribute(MyLogger::class);

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
$container->registerFromDirectory(
    __DIR__ . '/src/Services',
    'App\\Services'
);
```

---

## 2. Decorator Priorities

### Overview

–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```php
$container = new Container();
$container->set('api', fn() => new ApiClient());

// Priority 10 - –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –ø–µ—Ä–≤—ã–º
$container->decorate('api', function($api, $c) {
    return new AuthDecorator($api);
}, 10);

// Priority 5 - –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –≤—Ç–æ—Ä—ã–º
$container->decorate('api', function($api, $c) {
    return new RateLimitDecorator($api);
}, 5);

// Priority 1 - –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º
$container->decorate('api', function($api, $c) {
    return new LoggingDecorator($api);
}, 1);

// –ü–æ—Ä—è–¥–æ–∫: Auth ‚Üí RateLimit ‚Üí Logging
$api = $container->get('api');
```

### –ü—Ä–∞–≤–∏–ª–∞

- **Lower priority = applied first** (–º–µ–Ω—å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ)
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é priority = 0
- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–æ–ø—É—Å—Ç–∏–º—ã

---

## 3. Service Locator Pattern

### Overview

Service Locator –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤—É —Å–µ—Ä–≤–∏—Å–æ–≤.

### –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞—Ç–æ—Ä–∞

```php
$container = new Container();
$container->set('service1', fn() => new Service1());
$container->set('service2', fn() => new Service2());
$container->set('internal.service', fn() => new InternalService());

// –õ–æ–∫–∞—Ç–æ—Ä —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º —Å–µ—Ä–≤–∏—Å–æ–≤
$locator = $container->createServiceLocator(['service1', 'service2']);

$locator->has('service1');         // true
$locator->has('internal.service'); // false

$service1 = $locator->get('service1'); // ‚úì
// $locator->get('internal.service');  // ‚úó NotFoundException
```

### –õ–æ–∫–∞—Ç–æ—Ä –∏–∑ —Ç–µ–≥–∞

```php
$container->tag('service1', 'public');
$container->tag('service2', 'public');

$publicLocator = ServiceLocator::fromTag($container, 'public');

// –î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å—ã —Å —Ç–µ–≥–æ–º 'public'
$services = $publicLocator->getServiceIds(); // ['service1', 'service2']
```

### Use Cases

1. **API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤**: –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º
2. **–ü–ª–∞–≥–∏–Ω—ã**: –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

---

## 4. Container Delegation

### Overview

–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∏—Å–∫–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```php
$mainContainer = new Container();
$mainContainer->set('app.service', fn() => new AppService());

$pluginContainer = new Container();
$pluginContainer->set('plugin.feature', fn() => new PluginFeature());

// –î–æ–±–∞–≤–∏—Ç—å delegate
$mainContainer->addDelegate($pluginContainer);

// –°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –æ–±–æ–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
$app = $mainContainer->get('app.service');      // –∏–∑ main
$plugin = $mainContainer->get('plugin.feature'); // –∏–∑ delegate
```

### –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

1. –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
2. Delegates (–≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
3. Autowiring (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
4. NotFoundException

### Use Cases

1. **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Å–æ —Å–≤–æ–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
2. **–ü–ª–∞–≥–∏–Ω—ã**: –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–ª–∞–≥–∏–Ω–æ–≤
3. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã**: —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

---

## 5. Scoped Containers

### Overview

Scoped containers —É–ø—Ä–∞–≤–ª—è—é—Ç lifecycle —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ scope (request, session, etc.).

### –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```php
$container = new Container();
$container->set('request.data', fn() => new RequestData());
$container->set('global.config', fn() => new Config());

$scopedContainer = new ScopedContainer($container);

// –ù–∞–∑–Ω–∞—á–∏—Ç—å scope –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞
$scopedContainer->setScope('request.data', 'request');

// –ù–∞—á–∞—Ç—å scope
$scopedContainer->beginScope('request');

$data1 = $scopedContainer->get('request.data');
$data2 = $scopedContainer->get('request.data'); // same instance

// –ó–∞–≤–µ—Ä—à–∏—Ç—å scope (–æ—á–∏—Å—Ç–∏—Ç—å instances)
$scopedContainer->endScope();

// –ù–æ–≤—ã–π scope
$scopedContainer->beginScope('request');
$data3 = $scopedContainer->get('request.data'); // –Ω–æ–≤—ã–π instance
$scopedContainer->endScope();
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ Scopes

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ –∏–º–µ–Ω–∞:

- `'request'` - HTTP request lifecycle
- `'session'` - —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `'transaction'` - database transaction
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ scopes

### Use Cases

1. **Web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: request-scoped services
2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: rollback services –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

---

## 6. Async Service Initialization

### Overview

Generator-based –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Fibers –≤ PHP 8.1+).

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```php
$container = new Container();
$container->set('service1', fn() => new HeavyService1());
$container->set('service2', fn() => new HeavyService2());
$container->set('service3', fn() => new HeavyService3());

// –û–¥–∏–Ω–æ—á–Ω–∞—è async –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
foreach ($container->getAsync('service1') as $service) {
    // $service –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
}

// Batch initialization
foreach ($container->batchGetAsync(['service1', 'service2', 'service3']) as $id => $service) {
    echo "Initialized: {$id}\n";
}
```

### Future

–í –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Fibers:

```php
// –ì–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥ –¥–ª—è PHP 8.2+
$fiber = new Fiber(function() use ($container) {
    return $container->get('heavy.service');
});

$fiber->start();
// ... –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
$service = $fiber->getReturn();
```

---

## 7. Compiled Container with Tags

### Overview

Compiled container —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è ultra-fast –¥–æ—Å—Ç—É–ø–∞.

### –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å —Ç–µ–≥–∞–º–∏

```php
$container = new Container();

$container->set('cache', fn() => new RedisCache());
$container->tag('cache', 'infrastructure', ['priority' => 10]);

$container->set('logger', fn() => new FileLogger());
$container->tag('logger', 'infrastructure', ['priority' => 5]);
$container->tag('logger', 'logging');

// Compile
$container->compileToFile(__DIR__ . '/cache/CompiledContainer.php');
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ compiled container

```php
require __DIR__ . '/cache/CompiledContainer.php';

$container = new \CloudCastle\DI\Compiled\CompiledContainer();

// –¢–µ–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏
$infrastructure = $container->findTaggedServiceIds('infrastructure');
// ['cache', 'logger']

$tags = $container->getServiceTags('logger');
// ['infrastructure', 'logging']

$attributes = $container->getTagAttributes('cache', 'infrastructure');
// ['priority' => 10]
```

### Performance

Compiled container —Å —Ç–µ–≥–∞–º–∏:

- **0 reflection overhead**
- **Pre-computed tag mappings**
- **Inline match statements**
- **10-100x faster** —á–µ–º runtime –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

---

## 8. WeakMap Optimization

### Overview

LazyProxy —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç WeakMap –¥–ª—è tracking –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ–∑ memory leaks.

### –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç

```php
$container = new Container();
$container->setLazy('heavy', fn() => new HeavyService());

$proxy = $container->get('heavy'); // LazyProxy

// WeakMap –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–µ–∫–∞–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
// –ö–æ–≥–¥–∞ $proxy –±—É–¥–µ—Ç —Å–æ–±—Ä–∞–Ω GC, tracking —Ç–æ–∂–µ —É–¥–∞–ª–∏—Ç—Å—è

unset($proxy); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–µ–∑ memory leaks
```

### Benefits

1. **No memory leaks**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
2. **Performance**: O(1) lookup
3. **Compatibility**: PHP 8.0+

---

## –°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Ñ–∏—á–∏ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–º–µ—Å—Ç–µ:

```php
// 1. Setup —Å attributes
#[Service(id: 'api', tags: ['http'], lazy: false)]
#[Tag('infrastructure', ['priority' => 10])]
class ApiClient {}

// 2. Container setup
$container = new Container();
$container->enableAutowiring();
$container->registerFromAttribute(ApiClient::class);

// 3. Decorators —Å priorities
$container->decorate('api', fn($api) => new AuthDecorator($api), 10);
$container->decorate('api', fn($api) => new LogDecorator($api), 5);

// 4. Scoped
$scoped = new ScopedContainer($container);
$scoped->setScope('api', 'request');

// 5. Compile –¥–ª—è production
$container->compileToFile(__DIR__ . '/cache/CompiledContainer.php');
```

---

## Performance Comparison

| Feature | Runtime | Compiled | Improvement |
|---------|---------|----------|-------------|
| Service Get | 0.5¬µs | 0.05¬µs | **10x** |
| Tag Lookup | 2.0¬µs | 0.1¬µs | **20x** |
| Attributes | 50¬µs (reflection) | 0¬µs (pre-compiled) | **‚àûx** |
| Decorator Apply | 1.5¬µs | 1.5¬µs | 1x |
| Scope Check | 0.3¬µs | 0.3¬µs | 1x |

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–ë–∞–∑–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](ADVANCED_FEATURES.md)
- [Compilation Guide](COMPILATION.md)
- [–ü—Ä–∏–º–µ—Ä—ã](../examples/advanced-features-example.php)

---

**CloudCastle DI Container v2.0+** - Production-ready DI —Å enterprise features.

